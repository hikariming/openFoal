services:
  gateway:
    profiles: ["personal", "enterprise"]
    build:
      context: .
      dockerfile: docker/gateway.Dockerfile
    environment:
      OPENFOAL_GATEWAY_HOST: "0.0.0.0"
      OPENFOAL_GATEWAY_PORT: "8787"
      OPENFOAL_GATEWAY_SQLITE_PATH: "/data/gateway.sqlite"
      OPENFOAL_GATEWAY_STORAGE_BACKEND: "${OPENFOAL_GATEWAY_STORAGE_BACKEND:-sqlite}"
      OPENFOAL_POSTGRES_URL: "${OPENFOAL_POSTGRES_URL:-postgres://openfoal:openfoal@postgres:5432/openfoal}"
      OPENFOAL_REDIS_URL: "${OPENFOAL_REDIS_URL:-redis://redis:6379}"
      OPENFOAL_IDEMPOTENCY_BACKEND: "${OPENFOAL_IDEMPOTENCY_BACKEND:-storage}"
      OPENFOAL_BLOB_BACKEND: "${OPENFOAL_BLOB_BACKEND:-fs}"
      OPENFOAL_MINIO_ENDPOINT: "${OPENFOAL_MINIO_ENDPOINT:-http://minio:9000}"
      OPENFOAL_MINIO_REGION: "${OPENFOAL_MINIO_REGION:-us-east-1}"
      OPENFOAL_MINIO_ACCESS_KEY: "${OPENFOAL_MINIO_ACCESS_KEY:-openfoal}"
      OPENFOAL_MINIO_SECRET_KEY: "${OPENFOAL_MINIO_SECRET_KEY:-openfoal123}"
      OPENFOAL_MINIO_BUCKET: "${OPENFOAL_MINIO_BUCKET:-openfoal-enterprise}"
      OPENFOAL_ORCHESTRATOR_HEALTH_URL: "${OPENFOAL_ORCHESTRATOR_HEALTH_URL:-http://docker-runner:8081/health}"
      OPENFOAL_AUTH_MODE: "${OPENFOAL_AUTH_MODE:-none}"
      OPENFOAL_ENTERPRISE_REQUIRE_AUTH: "${OPENFOAL_ENTERPRISE_REQUIRE_AUTH:-false}"
      OPENFOAL_LOCAL_JWT_SECRET: "${OPENFOAL_LOCAL_JWT_SECRET:-openfoal-local-dev-secret}"
      OPENFOAL_LOCAL_JWT_EXPIRES_IN: "${OPENFOAL_LOCAL_JWT_EXPIRES_IN:-1h}"
      OPENFOAL_LOCAL_ADMIN_USERNAME: "${OPENFOAL_LOCAL_ADMIN_USERNAME:-admin}"
      OPENFOAL_LOCAL_ADMIN_PASSWORD: "${OPENFOAL_LOCAL_ADMIN_PASSWORD:-admin123!}"
      OPENFOAL_LOCAL_DEFAULT_TENANT_CODE: "${OPENFOAL_LOCAL_DEFAULT_TENANT_CODE:-default}"
      OPENFOAL_LOCAL_DEFAULT_WORKSPACE_ID: "${OPENFOAL_LOCAL_DEFAULT_WORKSPACE_ID:-w_default}"
      OPENFOAL_JWT_ISSUER: "${OPENFOAL_JWT_ISSUER:-}"
      OPENFOAL_JWT_AUDIENCE: "${OPENFOAL_JWT_AUDIENCE:-}"
      OPENFOAL_JWKS_URL: "${OPENFOAL_JWKS_URL:-}"
      OPENFOAL_CORE_ENGINE: "${OPENFOAL_CORE_ENGINE:-legacy}"
      OPENFOAL_ENTERPRISE_STORAGE_ROOT: "/data/openfoal"
    volumes:
      - gateway_data:/data
      - enterprise_storage:/data/openfoal
    ports:
      - "${OPENFOAL_GATEWAY_HOST_PORT:-8787}:8787"
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "const http=require('node:http');const req=http.get('http://127.0.0.1:8787/health',(res)=>{process.exit(res.statusCode===200?0:1)});req.on('error',()=>process.exit(1));req.setTimeout(2000,()=>{req.destroy();process.exit(1);});"
        ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  personal-web:
    profiles: ["personal"]
    build:
      context: .
      dockerfile: docker/personal-web.Dockerfile
    depends_on:
      gateway:
        condition: service_healthy
    ports:
      - "5180:80"
    restart: unless-stopped

  web-console:
    profiles: ["enterprise"]
    build:
      context: .
      dockerfile: docker/web-console.Dockerfile
    depends_on:
      gateway:
        condition: service_healthy
    environment:
      OPENFOAL_GATEWAY_BASE_URL: "http://localhost:8787"
    ports:
      - "${OPENFOAL_WEB_CONSOLE_HOST_PORT:-5200}:80"
    restart: unless-stopped

  postgres:
    profiles: ["enterprise"]
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: "${OPENFOAL_PG_DB:-openfoal}"
      POSTGRES_USER: "${OPENFOAL_PG_USER:-openfoal}"
      POSTGRES_PASSWORD: "${OPENFOAL_PG_PASSWORD:-openfoal}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${OPENFOAL_PG_HOST_PORT:-15432}:5432"
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${OPENFOAL_PG_USER:-openfoal} -d ${OPENFOAL_PG_DB:-openfoal}"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  redis:
    profiles: ["enterprise"]
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    ports:
      - "${OPENFOAL_REDIS_HOST_PORT:-16379}:6379"
    expose:
      - "6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  minio:
    profiles: ["enterprise"]
    image: minio/minio:RELEASE.2025-07-23T15-54-02Z
    environment:
      MINIO_ROOT_USER: "${OPENFOAL_MINIO_ACCESS_KEY:-openfoal}"
      MINIO_ROOT_PASSWORD: "${OPENFOAL_MINIO_SECRET_KEY:-openfoal123}"
    command: ["server", "/data", "--console-address", ":9001"]
    volumes:
      - minio_data:/data
    ports:
      - "${OPENFOAL_MINIO_HOST_PORT:-19000}:9000"
      - "${OPENFOAL_MINIO_CONSOLE_PORT:-19001}:9001"
    restart: unless-stopped

  minio-init:
    profiles: ["enterprise"]
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z
    depends_on:
      minio:
        condition: service_started
    environment:
      OPENFOAL_MINIO_ENDPOINT: "${OPENFOAL_MINIO_ENDPOINT:-http://minio:9000}"
      OPENFOAL_MINIO_ACCESS_KEY: "${OPENFOAL_MINIO_ACCESS_KEY:-openfoal}"
      OPENFOAL_MINIO_SECRET_KEY: "${OPENFOAL_MINIO_SECRET_KEY:-openfoal123}"
      OPENFOAL_MINIO_BUCKET: "${OPENFOAL_MINIO_BUCKET:-openfoal-enterprise}"
    entrypoint: ["/bin/sh", "-c"]
    command:
      [
        "until mc alias set local $$OPENFOAL_MINIO_ENDPOINT $$OPENFOAL_MINIO_ACCESS_KEY $$OPENFOAL_MINIO_SECRET_KEY; do sleep 1; done; mc mb -p local/$$OPENFOAL_MINIO_BUCKET || true; mc version enable local/$$OPENFOAL_MINIO_BUCKET || true"
      ]
    restart: "no"

  docker-runner:
    profiles: ["enterprise"]
    build:
      context: .
      dockerfile: docker/docker-runner.Dockerfile
    environment:
      ORCHESTRATOR_HOST: "0.0.0.0"
      ORCHESTRATOR_PORT: "8081"
      ORCHESTRATOR_AUTH_TOKEN: "runner-demo-token"
      ORCHESTRATOR_WORKSPACE_ROOT: "/data/openfoal"
      ORCHESTRATOR_DEFAULT_TIMEOUT_MS: "15000"
      ORCHESTRATOR_IDLE_TTL_SEC: "900"
      ORCHESTRATOR_MAX_TTL_SEC: "7200"
      ORCHESTRATOR_REDIS_URL: "${OPENFOAL_REDIS_URL:-redis://redis:6379}"
      ORCHESTRATOR_BLOB_BACKEND: "${ORCHESTRATOR_BLOB_BACKEND:-minio}"
      ORCHESTRATOR_MINIO_ENDPOINT: "${OPENFOAL_MINIO_ENDPOINT:-http://minio:9000}"
      ORCHESTRATOR_MINIO_REGION: "${OPENFOAL_MINIO_REGION:-us-east-1}"
      ORCHESTRATOR_MINIO_ACCESS_KEY: "${OPENFOAL_MINIO_ACCESS_KEY:-openfoal}"
      ORCHESTRATOR_MINIO_SECRET_KEY: "${OPENFOAL_MINIO_SECRET_KEY:-openfoal123}"
      ORCHESTRATOR_MINIO_BUCKET: "${OPENFOAL_MINIO_BUCKET:-openfoal-enterprise}"
    volumes:
      - enterprise_storage:/data/openfoal
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    pids_limit: 256
    mem_limit: 2g
    cpus: 1.0
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    expose:
      - "8081"
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "const http=require('node:http');const req=http.get('http://127.0.0.1:8081/health',(res)=>{process.exit(res.statusCode===200?0:1)});req.on('error',()=>process.exit(1));req.setTimeout(2000,()=>{req.destroy();process.exit(1);});"
        ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  bootstrap-enterprise:
    profiles: ["enterprise"]
    image: node:22-alpine
    depends_on:
      gateway:
        condition: service_healthy
      docker-runner:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    working_dir: /app
    environment:
      GATEWAY_BASE_URL: "http://gateway:8787"
      BOOTSTRAP_TENANT_ID: "t_default"
      BOOTSTRAP_WORKSPACE_ID: "w_default"
      BOOTSTRAP_AGENT_ID: "a_default"
      BOOTSTRAP_TARGET_ID: "target_enterprise_docker"
      BOOTSTRAP_RUNNER_ENDPOINT: "http://docker-runner:8081/execute"
      BOOTSTRAP_RUNNER_TOKEN: "runner-demo-token"
      BOOTSTRAP_ACTOR: "system-bootstrap"
    volumes:
      - ./:/app:ro
    command: ["node", "scripts/bootstrap-enterprise.mjs"]
    restart: "no"

volumes:
  gateway_data:
  enterprise_storage:
  postgres_data:
  redis_data:
  minio_data:
