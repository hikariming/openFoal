#!/usr/bin/env bash

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="$ROOT_DIR/backend"
FRONTEND_DIR="$ROOT_DIR/frontend"

if [[ ! -d "$BACKEND_DIR" || ! -d "$FRONTEND_DIR" ]]; then
  echo "backend/frontend directory not found under: $ROOT_DIR"
  exit 1
fi

if [[ ! -d "$BACKEND_DIR/node_modules" ]]; then
  echo "backend dependencies not found. Run: (cd backend && npm install)"
  exit 1
fi

if [[ ! -d "$FRONTEND_DIR/node_modules" ]]; then
  echo "frontend dependencies not found. Run: (cd frontend && npm install)"
  exit 1
fi

backend_pid=""
frontend_pid=""

cleanup() {
  echo ""
  echo "Shutting down services..."

  if [[ -n "${backend_pid}" ]] && kill -0 "${backend_pid}" 2>/dev/null; then
    kill "${backend_pid}" 2>/dev/null || true
  fi

  if [[ -n "${frontend_pid}" ]] && kill -0 "${frontend_pid}" 2>/dev/null; then
    kill "${frontend_pid}" 2>/dev/null || true
  fi

  wait 2>/dev/null || true
}

trap cleanup INT TERM EXIT

echo "Starting backend dev server..."
npm run dev --prefix "$BACKEND_DIR" &
backend_pid=$!

echo "Starting frontend dev server..."
npm run dev --prefix "$FRONTEND_DIR" &
frontend_pid=$!

echo "Backend PID: $backend_pid"
echo "Frontend PID: $frontend_pid"
echo "Press Ctrl+C to stop both."

while true; do
  if ! kill -0 "$backend_pid" 2>/dev/null; then
    echo "Backend process exited."
    exit 1
  fi

  if ! kill -0 "$frontend_pid" 2>/dev/null; then
    echo "Frontend process exited."
    exit 1
  fi

  sleep 1
done
