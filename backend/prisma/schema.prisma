generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccountStatus {
  PENDING
  UNINITIALIZED
  ACTIVE
  BANNED
  CLOSED
}

enum TenantStatus {
  NORMAL
  ARCHIVE
}

enum TenantAccountRole {
  ADMIN
  MEMBER
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

enum RunJobType {
  CHAT
  SCHEDULED
}

enum RunJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  CANCELED
}

enum SkillStatus {
  DRAFT
  PUBLISHED
  DEPRECATED
}

enum SandboxStatus {
  RUNNING
  STOPPED
  ERROR
}

model Tenant {
  id                  String              @id @default(uuid())
  name                String
  encryptPublicKey    String?             @map("encrypt_public_key")
  plan                String              @default("basic")
  status              TenantStatus        @default(NORMAL)
  customConfig        Json?               @map("custom_config")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  tenantAccounts      TenantAccountJoin[]
  invitationsUsed     InvitationCode[]    @relation("InvitationUsedByTenant")
  agents              Agent[]
  sessions            Session[]
  messages            Message[]
  toolCalls           ToolCall[]
  runJobs             RunJob[]
  skills              Skill[]
  skillBindings       SkillBinding[]
  sandboxes           Sandbox[]
  sandboxLeases       SandboxLease[]
  sandboxEvents       SandboxEvent[]
  auditLogs           AuditLog[]
  secrets             SecretRef[]

  @@map("tenants")
}

model Account {
  id                 String              @id @default(uuid())
  name               String
  email              String              @unique(map: "account_email_key")
  password           String?
  passwordHash       String?             @map("password_hash")
  passwordSalt       String?             @map("password_salt")
  avatar             String?
  interfaceLanguage  String?             @map("interface_language")
  interfaceTheme     String?             @map("interface_theme")
  timezone           String?
  lastLoginAt        DateTime?           @map("last_login_at")
  lastLoginIp        String?             @map("last_login_ip")
  lastActiveAt       DateTime            @default(now()) @map("last_active_at")
  status             AccountStatus       @default(ACTIVE)
  initializedAt      DateTime?           @map("initialized_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  tenantAccounts     TenantAccountJoin[]
  integrations       AccountIntegrate[]
  messages           Message[]           @relation("MessageAuthor")
  auditLogs          AuditLog[]          @relation("AuditActor")
  invitedTenantJoins TenantAccountJoin[] @relation("TenantAccountInviter")
  invitationsUsed    InvitationCode[]    @relation("InvitationUsedByAccount")

  @@map("accounts")
}

model TenantAccountJoin {
  id        String            @id @default(uuid())
  tenantId  String            @map("tenant_id")
  accountId String            @map("account_id")
  current   Boolean           @default(false)
  role      TenantAccountRole @default(MEMBER)
  invitedBy String?           @map("invited_by")
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account   Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  inviter   Account?          @relation("TenantAccountInviter", fields: [invitedBy], references: [id], onDelete: SetNull)

  @@unique([tenantId, accountId], map: "unique_tenant_account_join")
  @@index([tenantId], map: "tenant_account_join_tenant_id_idx")
  @@index([accountId], map: "tenant_account_join_account_id_idx")
  @@map("tenant_account_joins")
}

model AccountIntegrate {
  id             String   @id @default(uuid())
  accountId      String   @map("account_id")
  provider       String
  openId         String   @map("open_id")
  encryptedToken String   @map("encrypted_token")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  account        Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, provider], map: "unique_account_provider")
  @@unique([provider, openId], map: "unique_provider_open_id")
  @@map("account_integrates")
}

model InvitationCode {
  id              Int       @id @default(autoincrement())
  batch           String
  code            String
  status          String    @default("unused")
  usedAt          DateTime? @map("used_at")
  usedByTenantId  String?   @map("used_by_tenant_id")
  usedByAccountId String?   @map("used_by_account_id")
  deprecatedAt    DateTime? @map("deprecated_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  usedByTenant    Tenant?   @relation("InvitationUsedByTenant", fields: [usedByTenantId], references: [id], onDelete: SetNull)
  usedByAccount   Account?  @relation("InvitationUsedByAccount", fields: [usedByAccountId], references: [id], onDelete: SetNull)

  @@index([batch], map: "invitation_codes_batch_idx")
  @@index([code, status], map: "invitation_codes_code_idx")
  @@map("invitation_codes")
}

model Agent {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions    Session[]
  runJobs     RunJob[]

  @@index([tenantId, updatedAt])
}

model Session {
  id            String         @id @default(cuid())
  tenantId      String
  agentId       String?
  title         String?
  status        String         @default("active")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  endedAt       DateTime?
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent         Agent?         @relation(fields: [agentId], references: [id], onDelete: SetNull)
  messages      Message[]
  toolCalls     ToolCall[]
  runJobs       RunJob[]
  sandboxLeases SandboxLease[]

  @@index([tenantId, updatedAt])
}

model Message {
  id        String      @id @default(cuid())
  sessionId String
  tenantId  String
  role      MessageRole
  text      String?
  content   Json?
  authorId  String?
  createdAt DateTime    @default(now())
  session   Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tenant    Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  author    Account?    @relation("MessageAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  toolCalls ToolCall[]

  @@index([sessionId, createdAt])
}

model ToolCall {
  id        String    @id @default(cuid())
  sessionId String
  tenantId  String
  messageId String?
  runJobId  String?
  toolName  String
  status    String
  input     Json?
  output    Json?
  error     String?
  startedAt DateTime  @default(now())
  finishedAt DateTime?
  session   Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  message   Message?  @relation(fields: [messageId], references: [id], onDelete: SetNull)
  runJob    RunJob?   @relation(fields: [runJobId], references: [id], onDelete: SetNull)

  @@index([tenantId, startedAt])
}

model RunJob {
  id            String         @id @default(cuid())
  tenantId      String
  agentId       String?
  sessionId     String?
  type          RunJobType     @default(CHAT)
  status        RunJobStatus   @default(QUEUED)
  triggeredBy   String
  scheduleKey   String?
  input         Json?
  output        Json?
  error         String?
  startedAt     DateTime?
  finishedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent         Agent?         @relation(fields: [agentId], references: [id], onDelete: SetNull)
  session       Session?       @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  toolCalls     ToolCall[]
  sandboxLeases SandboxLease[]

  @@index([tenantId, status, createdAt])
}

model Skill {
  id          String         @id @default(cuid())
  tenantId    String
  name        String
  description String?
  status      SkillStatus    @default(DRAFT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  versions    SkillVersion[]
  bindings    SkillBinding[]

  @@unique([tenantId, name])
}

model SkillVersion {
  id             String   @id @default(cuid())
  skillId         String
  version         Int
  promptTemplate  String?
  changelog       String?
  createdAt       DateTime @default(now())
  skill           Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([skillId, version])
}

model SkillBinding {
  id             String   @id @default(cuid())
  tenantId       String
  skillId        String
  mcpServer      String?
  sandboxProfile String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  skill          Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([tenantId, mcpServer])
}

model Sandbox {
  id              String         @id @default(cuid())
  tenantId        String
  name            String
  image           String
  runtime         String
  region          String
  status          SandboxStatus  @default(STOPPED)
  autoStopEnabled Boolean        @default(true)
  cpuCores        Int            @default(2)
  memoryMb        Int            @default(4096)
  lastActiveAt    DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  leases          SandboxLease[]
  events          SandboxEvent[]

  @@unique([tenantId, name])
}

model SandboxLease {
  id        String    @id @default(cuid())
  tenantId  String
  sandboxId String
  sessionId String?
  runJobId  String?
  leaseType String
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sandbox   Sandbox   @relation(fields: [sandboxId], references: [id], onDelete: Cascade)
  session   Session?  @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  runJob    RunJob?   @relation(fields: [runJobId], references: [id], onDelete: SetNull)

  @@index([tenantId, startedAt])
}

model SandboxEvent {
  id        String   @id @default(cuid())
  tenantId  String
  sandboxId String
  level     String   @default("info")
  message   String
  payload   Json?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sandbox   Sandbox  @relation(fields: [sandboxId], references: [id], onDelete: Cascade)

  @@index([sandboxId, createdAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String
  actorId     String?
  action      String
  resourceType String
  resourceId  String?
  result      String
  ipAddress   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor       Account? @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([tenantId, action])
}

model SecretRef {
  id             String   @id @default(cuid())
  tenantId       String
  key            String
  provider       String   @default("minio")
  encryptedValue String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
}
